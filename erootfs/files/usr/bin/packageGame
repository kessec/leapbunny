#!/bin/sh
#
#  YTu  10/23/2009 v1
#
#
# set -x

usage() {
    cat <<EOF

Usage:	$0 -bp OutDir InGameDir

This utility creates a game OTP image (.bin) and/or Leapfrog package (.lfp) for the game

Parameters:
	-p:		Create a lfp package
	-b:		Create a binary file suitable to burn into OTP cartridge
	outDir:		output directory
	InGameDir: 	a path to the game directory.
	
Examples:
	$0 -bp out ~/gamespace/harmonies
	$0 -b out ~/gamespace/harmonies
	$0 -p out ~/gamespace/harmonies
EOF
}

# Check for usage
if [ $# -ne "3" ]; then
	usage
	exit 0
fi

option=$1
outdir=$2
indir=$3
exit_code=0

if [ ! -d "$indir" ]; then
	echo Error: Input directory $infile does not exist
	exit 1
elif [ ! -d "$outdir" ]; then
	echo Error: output directory $outDir does not exist
	exit 1
elif [ ! -f $indir/meta.inf ]; then	
	echo Error: input directory structure problem: no meta.inf
	exit 1
fi

if [ "$option" = "-bp" -o "$option" = "-pb" ]; then
	gen_lfp=1
	gen_bin=1
elif [ "$option" = "-b" ]; then
	gen_lfp=0
	gen_bin=1
elif [ "$option" = "-p" ]; then
	gen_lfp=1
	gen_bin=0
else
	echo Error: unknown option $option
	exit 1
fi


##############################################################################
date=`date '+%Y%m%d-%H%M'`
if [ "x$who" = "x" ]; then
    who=anonymous
fi

echo "Generating package on $date by " $who
echo "Please wait ..."

# remove the trailing / if there is one
indir=`echo $3 |  sed -e "s/\/$//"`

if [ -e /etc/version ]; then
	lfp_temp_path=`mktemp lfp_XXXXX`
	rm -f $lfp_temp_path
	lfp_temp_path=`pwd`/$lfp_temp_path.lfp
	lfpkg -a create -o $lfp_temp_path $indir  > /dev/null
else
	lfp_temp_path=`mktemp lfp_XXXXX`
	rm -f $lfp_temp_path	
	lfp_temp_path=`pwd`/$lfp_temp_path.lfp
	current_path=`pwd`
	is_sdk=`echo $current_path | grep "CoreTools"`
	if [ ! -z "$is_sdk" ] ; then
		../lfpkg/lfpkg -a create -o $lfp_temp_path $indir  > /dev/null
	else
		./lfpkg -a create -o $lfp_temp_path $indir  > /dev/null
	fi
fi

if [ $? != 0 ]; then
	rm -f $lfp_temp_path
	echo "Error: the directory $outDir can't be used by lfpkg"
	exit 1
fi

META_VERSION=`grep -e '\<Version=' "$indir/meta.inf" | cut -d = -f 2- | cut -d \" -s -f 2`
lfp_file_path=$indir-$META_VERSION.lfp
lfp_file_name=`basename $lfp_file_path`
bin_file_name=`echo $lfp_file_name | sed 's/.lfp/.bin/'`

mv $lfp_temp_path $outdir/$lfp_file_name

if [ $gen_bin = 0 ]; then
	echo "Done !"
	exit 0
fi

if [ -e /etc/version ]; then
mkotp.sh 64 $outdir/$bin_file_name $outdir/$lfp_file_name
else
./mkotp.sh 64 $outdir/$bin_file_name $outdir/$lfp_file_name
fi

if [ $? -ne 0 ]; then
	echo "Error: can't package game"
	exit_code=1
fi

if [ $gen_lfp = 0 ]; then
	rm -f $outdir/$lfp_file_name
fi

exit $exit_code
