#!/bin/sh

# First, see if by some feat of timing, the user yanked the USB cable
# during the small window after the surgeon has loaded, but before he
# got here.
vbus=`cat /sys/devices/platform/lf1000-usbgadget/vbus`
if [ "$vbus" != 0 ]; then
	# Good: USB is still attached still
# 11oct10
	if [ `cat /sys/devices/platform/lf1000-nand/base_nand_internal_ecc_support` = "1" ]; then
		echo "InternalEccSupported"
		if [ `cat /sys/devices/platform/lf1000-nand/base_nand_internal_ecc_enabled` = "0" ]; then
			# supported but not enabled
			echo "InternalEccNotEnabled"
			if [ -e /sys/class/graphics ]; then
				#imager-fb /dev/fb0 /var/screens/UPDATE_IN_PROGRESS.png
				drawtext-fb /dev/fb0 /var/fonts/monotext8x16.rgb "Internal ECC not enabled" 12 12 1
			else
				#imager /dev/layer0 /var/screens/UPDATE_IN_PROGRESS.png
				drawtext /dev/layer0 /var/fonts/monotext8x16.rgb "Internal ECC not enabled" 12 12 1
			fi

		elif [ `cat /sys/devices/platform/lf1000-nand/base_nand_ecc_mode` != "4" ]; then
			# internal ecc supported and enabled but not using that ecc mode
			echo "InternalEccEnabledNotUsed"
			if [ -e /sys/class/graphics ]; then
				#imager-fb /dev/fb0 /var/screens/UPDATE_IN_PROGRESS.png
				drawtext-fb /dev/fb0 /var/fonts/monotext8x16.rgb "Internal ECC not used" 12 12 1
			else
				#imager /dev/layer0 /var/screens/UPDATE_IN_PROGRESS.png
				drawtext /dev/layer0 /var/fonts/monotext8x16.rgb "Internal ECC not used" 12 12 1
			fi
		else
			# internal ecc supported, enabled, and used
			echo "InternalEccEnabledAndUsed"
			if [ -e /sys/class/graphics ]; then
				imager-fb /dev/fb0 /var/screens/SYS_0005_no_yellow.png
				flipbook-fb /var/screens/connect-pngs &
			else
				# Show progress
				L=/dev/layer0
				# imager $L /var/screens/SYS_0005_connect_stars.png
				imager $L /var/screens/SYS_0005_no_yellow.png
				# drawtext /dev/layer0 /var/fonts/monotext8x16.rgb "Placeholder Tune Up Movie" 13 8 1
				# sparks &
				flipbook /var/screens/connect-pngs &
			fi
		fi
	else
		echo "InternalEccNotSupported"
		if [ -e /sys/class/graphics ]; then
			imager-fb /dev/fb0 /var/screens/SYS_0005_no_yellow.png
			flipbook-fb /var/screens/connect-pngs &
		else
			# Show progress
			L=/dev/layer0
			# imager $L /var/screens/SYS_0005_connect_stars.png
			imager $L /var/screens/SYS_0005_no_yellow.png
			# drawtext /dev/layer0 /var/fonts/monotext8x16.rgb "Placeholder Tune Up Movie" 13 8 1
			# sparks &
			flipbook /var/screens/connect-pngs &
		fi
	fi

# 11oct10
#
#	if [ -e /sys/class/graphics ]; then
#		imager-fb /dev/fb0 /var/screens/SYS_0005_no_yellow.png
#		flipbook-fb /var/screens/connect-pngs &
#	else
#		# Show progress
#		L=/dev/layer0
#		# imager $L /var/screens/SYS_0005_connect_stars.png
#		imager $L /var/screens/SYS_0005_no_yellow.png
#		# drawtext /dev/layer0 /var/fonts/monotext8x16.rgb "Placeholder Tune Up Movie" 13 8 1
#		# sparks &
#		flipbook /var/screens/connect-pngs &
#	fi
# 11oct10 end of original

	# Launch fuse for Madrid
	if grep B /sys/devices/platform/lf1000-gpio/board_id > /dev/null; then
		echo "Launching fuse-flasher"
		mkdir /tmp/fuse
		mdev -s # Don't know why I need this so late, but /dev/mmcblk0 didn't show up before
		fuse-flasher /tmp/fuse
	fi

	# Wait for usb event to end session
	# This guy runs untils there is a vbus or disconnect
	surgeon-usb-socket

fi

# shutdown will detect /LF/doom
reboot
