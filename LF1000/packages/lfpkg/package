#!/bin/sh -e
#set -x

date=`date '+%Y%m%d-%H%M'`
#scriptDir=`dirname $0`
scriptName=`basename $0`
scriptDir=$(readlink -f "`dirname $0`")

BOLD="\033[1m"
NORM="\033[0m"
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
BOLDRED="\033[41m"

TAB="\t"
NL="\n"

RETURNSTRING=""
LOGMESSAGETYPE=""

usage() {
cat <<EOF

Usage:	$scriptName [options] <OutDir> <InDir>

$scriptName validates and packages a .lf2, .lfp, or .bin package. 
$scriptName generate a $scriptName.log file in the specified OutDir.
$scriptName copies inDir to OutDir and all changes are made to this copy.

Check this log file for any warnings or errors.

Options:
	-t <packageType>:	Specify type of package: lfp, bin, LPAD, LST3
				LPAD and LST3 will create .lf2 files
	-a:			Repackage all folders in InDir. Otherwise, we assume InDir is the folder to package.
	-v <versionString>:	Option to update Version. If set, next argument should be new version number, in quotes.
	-n:			If set, will not install compatibility libs with .bin builds.
				By default, this script installs compatibility libs for .bin builds.
	OutDir:			Output directory.
	InDir:			Either the path of the project, or all projects in that path (when -a is set).

Examples:
	$scriptName -t LPAD -a out/ gamespace/Downloads/
	$scriptName -t lfp -v "0.1.2.0" out/ gamespace/myGame/
	$scriptName -t bin out/ gamespace/myGame/
	
EOF
}

packageType="";
doAll=false;
newVersion="-1";
outPackage="defaultName";
isLF2=false;
DeviceName="LeapsterExplorer";
noCompatibility=false;
usePremadeMeta=false;

while getopts ":anv:t:" Option
do
	case $Option in
		n)	noCompatibility=true;
			shift 1;;
		a)	doAll=true;
			shift 1;;
		v)	shift $(($OPTIND-2));
			newVersion="$1";
			shift 1;;
		t)	shift $(($OPTIND-2));
			packageType="$1";
			shift 1;;
		*)	usage;
			exit 0;
	esac
done

#need to setup some lf2 specific info
if [ "$packageType" = "LPAD" ]; then
	exclude0="LST3";
	DeviceName="LeapPadExplorer";
	isLF2=true;
elif [ "$packageType" = "LST3" ]; then
	exclude0="LPAD";
	DeviceName="LeapsterExplorer";
	isLF2=true;
fi

#check type
if	[ $# != 2 ] ||
	[ $isLF2 != true ] &&
	[ "$packageType" != "lfp" ] &&
	[ "$packageType" != "bin" ]; then
	usage
	exit 1
fi

outDir=$(readlink -f "$1")
folder=$(readlink -f "$2")
baseFolder="$folder"
workingFolder="$outDir/"`basename "$folder"`

echo "---"
echo "$workingFolder"
echo "---"

TMPLOG=`mktemp /tmp/packageLog.XXXXXX`

getLogMessageType()
{
	#define log error severity here
	if [ "$isLF2" = true ]; then
		case "$1" in
			"MetaVersion")	LOGMESSAGETYPE="error";;
			"Device")			LOGMESSAGETYPE="error";;
			"Type")			LOGMESSAGETYPE="error";;
			"ProductID")		LOGMESSAGETYPE="error";;
			"PackageID")		LOGMESSAGETYPE="error";;
			"Locale")			LOGMESSAGETYPE="warning";;
			"PartNumber")		LOGMESSAGETYPE="error";;
			"AppSo")			LOGMESSAGETYPE="warning";;
			"Icon")			LOGMESSAGETYPE="warning";;
			"Version")		LOGMESSAGETYPE="warning";;
			"PreviewImage")	LOGMESSAGETYPE="error";;
			"Publisher")		LOGMESSAGETYPE="warning";;
			"Developer")		LOGMESSAGETYPE="warning";;
			"Name")			LOGMESSAGETYPE="warning";;
			"Size")			LOGMESSAGETYPE="warning";;
			"DeviceAccess")	LOGMESSAGETYPE="warning";;
			"Hidden")			LOGMESSAGETYPE="warning";;
			"Depends")		LOGMESSAGETYPE="warning";;
			"DataStorageSpace")		LOGMESSAGETYPE="warning";;
		esac
	elif [ "$packageType" = "lfp" ] || [ "$packageType" = "bin" ]; then
		case "$1" in
			"MetaVersion")	LOGMESSAGETYPE="error";;
			"Device")			LOGMESSAGETYPE="error";;
			"Type")			LOGMESSAGETYPE="error";;
			"ProductID")		LOGMESSAGETYPE="error";;
			"PackageID")		LOGMESSAGETYPE="error";;
			"Locale")			LOGMESSAGETYPE="warning";;
			"PartNumber")		LOGMESSAGETYPE="error";;
			"AppSo")			LOGMESSAGETYPE="error";;
			"Icon")			LOGMESSAGETYPE="error";;
			"Version")		LOGMESSAGETYPE="warning";;
			"PreviewImage")	LOGMESSAGETYPE="error";;
			"Publisher")		LOGMESSAGETYPE="warning";;
			"Developer")		LOGMESSAGETYPE="warning";;
			"Name")			LOGMESSAGETYPE="warning";;
			"Size")			LOGMESSAGETYPE="warning";;
			"DeviceAccess")	LOGMESSAGETYPE="warning";;
			"Hidden")			LOGMESSAGETYPE="warning";;
			"Depends")		LOGMESSAGETYPE="warning";;
			"DataStorageSpace")		LOGMESSAGETYPE="warning";;
		esac
	fi
}


logInfo()
{
	color="$NORM"
	case "$1" in
		*"[error]"*)			ERRORSREPORTED=$(($ERRORSREPORTED+1)); color=$RED;;
		*"[warning]"*)		WARNINGSREPORTED=$(($WARNINGSREPORTED+1)); color=$YELLOW;;
		*"[update]"*)			UPDATESREPORTED=$(($UPDATESREPORTED+1)); color=$GREEN;;
		*"[status]"*)			color=$BLUE;;
		*"[critical error]"*)	color=$BOLDRED;;
		*"##"*)			UPDATESREPORTED=$(($UPDATESREPORTED+1)); color=$BOLD;;
	esac
	echo "$color$1$NORM"
	echo "$1">>"$TMPLOG"
}

parseMeta()
{
	if [ "$1" = "string" ]; then
		RETURNSTRING=`grep -e '\<'$2'=' "$workingFolder/meta.inf" | cut -d = -f 2- | cut -d \" -s -f 2`
	elif [ "$1" = "int" ]; then
		RETURNSTRING=`grep -e '\<'$2'=' "$workingFolder/meta.inf" | cut -d = -f 2-`
	fi
	
	if [ -z "$RETURNSTRING" ]; then
		getLogMessageType $2
		logInfo "$TAB""[$LOGMESSAGETYPE] meta.inf - Missing $2"
	fi
}

updateMeta()
{
	parseMeta $1 "$2"; tmpVar="$RETURNSTRING";

	echo "">>"$workingFolder/meta.inf"
	if [ -z $tmpVar ]; then
		#add field
		if [ "$1" = "string" ]; then
			echo "$2=\"$3\"">>"$workingFolder/meta.inf"
		elif [ "$1" = "int" ]; then
			echo "$2=$3">> "$workingFolder/meta.inf"
		fi
	else
		#update field
		TMPMETA=`mktemp /tmp/meta.XXXXXX`
		
		if [ "$1" = "string" ]; then
			sed -e 's/^'$2'=.*/'$2'="'$3'"/' <  "$workingFolder/meta.inf" > "$TMPMETA"
		elif [ "$1" = "int" ]; then
			sed -e 's/^'$2'=.*/'$2'='$3'/' <  "$workingFolder/meta.inf" > "$TMPMETA"
		fi
		mv "$TMPMETA"  "$workingFolder/meta.inf"
	fi
	
	logInfo "$TAB""[update] meta.inf - $2: $3"
}

validateMeta()
{

	#convert meta.inf to Unix style
	TMPMETA=`mktemp /tmp/meta.XXXXXX`
	cp "$workingFolder/meta.inf" "$TMPMETA"
	tr -d "\r" < "$TMPMETA" >  "$workingFolder/meta.inf"
	rm "$TMPMETA"
	
	echo "$NL""$TAB""Validating meta.inf..."
	# read the meta.inf options so we can use them for the archive name and such
	parseMeta string 	"MetaVersion";	MetaVersion="$RETURNSTRING"
	parseMeta string 	"Device"; 		Device="$RETURNSTRING"
	parseMeta string 	"Type"; 			Type="$RETURNSTRING"
	parseMeta int 		"ProductID"; 		ProductID="$RETURNSTRING"
	parseMeta string 	"PackageID"; 		PackageID="$RETURNSTRING"
	parseMeta string 	"Locale"; 		Locale="$RETURNSTRING"
	if [ $Type != "MicroDownload" ]; then
		parseMeta string 	"PartNumber"; 		PartNumber="$RETURNSTRING"
	fi
	parseMeta string 	"AppSo"; 			AppSo="$RETURNSTRING"
	parseMeta string 	"Icon"; 			Icon="$RETURNSTRING"
	parseMeta string 	"Version"; 		Version="$RETURNSTRING"
	parseMeta string 	"Publisher"; 		Publisher="$RETURNSTRING"
	parseMeta string 	"Developer"; 		Developer="$RETURNSTRING"
	parseMeta string 	"Name"; 			Name="$RETURNSTRING"
#	parseMeta int 		"Size"; 			Size="$RETURNSTRING"
	parseMeta int 		"DeviceAccess"; 	DeviceAccess="$RETURNSTRING"
	parseMeta int 		"Hidden"; 		Hidden="$RETURNSTRING"
	parseMeta int 		"Depends"; 		Depends="$RETURNSTRING"
	parseMeta int 		"DataStorageSpace"; 		DataStorageSpace="$RETURNSTRING"
	
	cd $workingFolder
	metainf="meta.inf"
	
	#check to see if Device is correct

	if [ $isLF2 = true ]; then
		if [ $usePremadeMeta = false ]; then
			logInfo "$TAB""[status] No premade meta.inf found. Updating current version...";
			#Update meta.inf with platform type
			TMPMETA=`mktemp /tmp/meta.XXXXXX`
			if [ $packageType = "LST3" ]; then
				sed -e 's/\"LPAD-0x001E000F-/\"LST3-0x00170030-/g;s/\"LPAD-0x/\"LST3-0x/g' <  "$workingFolder/meta.inf" > "$TMPMETA"
				#sed -e 's/\"LPAD-0x/\"LST3-0x/g' <  "$workingFolder/meta.inf" > "$TMPMETA"
			elif [ $packageType = "LPAD" ]; then
				sed -e 's/\"LST3-0x00170030-/\"LPAD-0x001E000F-/g;s/\"LST3-0x/\"LPAD-0x/g' <  "$workingFolder/meta.inf" > "$TMPMETA"
				#sed -e 's/\"LST3-0x/\"LPAD-0x/g' <  "$workingFolder/meta.inf" > "$TMPMETA"
			fi
			mv "$TMPMETA"  "$workingFolder/meta.inf"

			#need to re-get the PackageID after this
			parseMeta string 	"PackageID"; 		PackageID="$RETURNSTRING"
			
			updateMeta string "Device" "$DeviceName"
			logInfo "$TAB""[update] meta.inf - Platform Type: $packageType"
		fi
	elif	[ "$Device" != "LeapsterExplorer" ] &&
		[ "$Device" != "LeapPadExplorer" ]; then
			logInfo '$TAB""[error] meta.inf - Device is not valid"'
	fi
	
	#check preview file
	parseMeta string "PreviewImage"; PreviewImage="$RETURNSTRING"
	preview=""
	if [ -n "$PreviewImage" ]; then
		preview="$PreviewImage"
		# show error if the preview file is not actually a real file		
		if [ ! -e "$preview" ]; then
			logInfo "$TAB""[error] PreviewImage - $preview not a real file"
			preview=""
		fi
	fi

	#check AppSo
	if [ ! -e $AppSo ]; then
		logInfo "$TAB""[error] AppSo - $AppSo not a real file"
	fi

	#check Icon
	if [ ! -e $Icon ]; then
		logInfo "$TAB""[error] Icon - $Icon not a real file"
	fi
	
	#check DataStorageSpace
	if [ "$DataStorageSpace" = '"update_me"' ]; then
		logInfo "$TAB""[error] DataStorageSpace - DataStorageSpace needs to be fixed!!"
	fi
	
	#check and update version (if -v flag was set)
	if [ "$newVersion" != "-1" ]; then
		updateMeta string "Version" "$newVersion"
		Version="$newVersion"
	fi
	
	#check size
	tmp=$(du -s -k)
	newSize=`echo "$tmp" | tr '.' ' '`
	newSize=$(($newSize*1024))
	updateMeta int "Size" "$newSize"

	outPackage="$outDir/$PackageID-$Version";
	chmod 644 "$workingFolder/meta.inf"
}


doChecksum()
{
	#do checksum
	echo "$NL""$TAB""Generating checksum..."
	TMPSUM=`mktemp /tmp/lfpkg.sum.XXXXXX`
	rm -f "$workingFolder"/packagefiles.md5
	WRKDIR=`pwd`
	cd "$workingFolder"
	find . -name '.svn' -prune -o -print | while read file;
	do
		if [ -f "$file" ] ; then
			md5sum "$file" >> "$TMPSUM"
		fi
	done
	cd "$WRKDIR"
	cp "$TMPSUM" "$workingFolder/packagefiles.md5"
	chmod 644 "$workingFolder/packagefiles.md5"
	rm "$TMPSUM"
	logInfo "$TAB""[update] checksum file: $workingFolder/packagefiles.md5"
}

packagelf2()
{
	#create the lf2
	if [ "$preview" != "" ]; then
		tar -Hustar -cpf "$outPackage.tar" "$metainf" "$preview"
		tar -Hustar -rpf "$outPackage.tar" --exclude="$metainf" --exclude="$preview" --exclude="$exclude0" *
	else
		tar -Hustar -cpf "$outPackage.tar" "$metainf"
		tar -Hustar -rpf "$outPackage.tar" --exclude="$metainf" --exclude="$exclude0" *
	fi
	
	bzip2 -9c "$outPackage.tar"  > "$outPackage.lf2"
	rm -f "$outPackage.tar"
}

packagelfp()
{
	lfpkg -a create -o "$outPackage.lfp" "$workingFolder"  > /dev/null
	
	if [ "$packageType" = "bin" ] && [ "$noCompatibility" = false ]; then
		#add compatibility stuff here
		cd "$scriptDir"
		echo `pwd`
		zip -r "$outPackage.lfp" "lib/"
	fi
}

packagebin()
{
	#need to cd to otp folder for mkotp.
	cd "$scriptDir"
	mkotp.sh 64 "$outPackage.bin" "$outPackage.lfp"
}


packit()
{
	FAIL=0
	ERRORSREPORTED=0
	WARNINGSREPORTED=0
	UPDATESREPORTED=0

	logInfo "___________________________________________________"
	logInfo "Packaging $folder"
	logInfo "___________________________________________________"

	echo "$NL""$TAB""Prepping Working folder: $workingFolder..."
	#copy everything to a new working folder (exclude svn if needed)
	logInfo "$TAB""[status] Copying $folder to $outDir"
	cd "$folder"
	cd ..
	
	workingFolder="$outDir/"`basename "$folder"`
	
	if [ -d $workingFolder ]; then
		logInfo "$TAB""[status] $workingFolder already exists. Removing it..."
		rm -r -f $workingFolder;
	fi

	tar -cpf  "$outDir/tmp.tar.gz" --exclude='.svn*' `basename "$folder"`
	cd "$outDir"
	tar xpf "tmp.tar.gz"
	rm -f "tmp.tar.gz"

	#move correct meta.inf over
	if [ -e $workingFolder/meta.inf.$packageType ]; then
		logInfo "$TAB""[status] Moving meta.inf.$packageType to meta.inf"	;
		mv -f "$workingFolder/meta.inf.$packageType" "$workingFolder/meta.inf";
		logInfo "$TAB""[status] Removing meta.inf.$exclude0"	;
		rm -f "$workingFolder/meta.inf.$exclude0";
		usePremadeMeta=true;
	elif [ ! -e $workingFolder/meta.inf ]; then
		logInfo "$TAB""[critical error] Missing meta.inf file"
		FAIL=1
		return
	fi

	validateMeta
	if [ $FAIL != 1 ]; then
		doChecksum

		#create package
		echo "$NL""$TAB""Cleaning..."
		if [ -e "$outPackage.lf2" ]; then
			logInfo "$TAB""[status] $outPackage.lf2 already exists. Removing it..."
			rm -r -f "$outPackage.lf2";
		fi
		if [ -e "$outPackage.lfp" ]; then
			logInfo "$TAB""[status] $outPackage.lfp already exists. Removing it..."
			rm -r -f "$outPackage.lfp";
		fi
		if [ -e "$outPackage.bin" ]; then
			logInfo "$TAB""[status] $outPackage.bin already exists. Removing it..."
			rm -r -f "$outPackage.bin";
		fi

		#create package
		echo "$NL""$TAB""Packaging..."
		if [ $isLF2 = true ]; then
			logInfo "$TAB""[status] Packaging $outPackage.lf2"
			packagelf2
		elif [ "$packageType" = "lfp" ]; then
			logInfo "$TAB""[status] Packaging $outPackage.lfp"	
			packagelfp
		elif [ "$packageType" = "bin" ]; then
			logInfo "$TAB""[status] Packaging $outPackage.bin"	
			packagelfp
			packagebin
		fi

		echo ""
		echo "$GREEN$TAB""$UPDATESREPORTED update(s)$NORM"
		echo "$YELLOW$TAB""$WARNINGSREPORTED warnings(s)$NORM"
		echo "$RED$TAB""$ERRORSREPORTED error(s)$NORM"
	else
		logInfo "$TAB""[critical error] Build aborted!!"
	fi
}

logInfo "## $scriptName log for $folder on $date ##"

if [ $doAll != true ]; then
	packit
else
	logInfo "____________________________________________________"
	logInfo "=== Packaging all $packageType within $folder directory"
	logInfo "____________________________________________________"
	logInfo""
	logInfo""

	find "$baseFolder"  -maxdepth 1 -mindepth 1 -noleaf -type d | while read folder; do
		packit
		cd ..
	done
fi

mv $TMPLOG "$outDir/package.log"

echo""
echo "See $outDir/package.log for more info."
echo""
