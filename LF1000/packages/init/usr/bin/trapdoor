#!/bin/sh

if [ -e /sys/class/graphics ]; then
	imager-fb /dev/fb0 /var/screens/UPDATE_IN_PROGRESS.png
	drawtext-fb /dev/fb0 /var/fonts/monotext8x16.rgb " Test Mode " 12 12 1
	MLC="0"
else
	imager /dev/layer0 /var/screens/UPDATE_IN_PROGRESS.png
	drawtext /dev/layer0 /var/fonts/monotext8x16.rgb " Test Mode " 12 12 1
	MLC="1"
fi

# Set Backlight low-setting.  This is the physical value to use for lowest backlight brightness
if [ -e /sys/devices/platform/lf1000-dpc/backlight_threshold ]; then
	mfgdata get bl > /sys/devices/platform/lf1000-dpc/backlight_threshold
fi

# if nonzero NOR values then set battery ADC slope and offset 
if [ "`mfgdata get adc`" != "0 0" ]; then 
	logger -s -t "Emerald Base" -p local4.notice "Use ADC settings from NOR `mfgdata get adc`"
	mfgdata get adc | cut -d ' ' -f 1 > /sys/devices/platform/lf1000-power/adc_constant 
	mfgdata get adc | cut -d ' ' -f 2 > /sys/devices/platform/lf1000-power/adc_slope_256 
else
	logger -s -t "Emerald Base" -p local4.notice "Use default ADC settings (NOR invalid)"
fi 


/etc/init.d/usbether start  
/etc/init.d/touchscreen start
/usr/bin/setcal

/etc/init.d/mounts start

/etc/init.d/dbus-1 start
/etc/init.d/networking start
/etc/init.d/avahi-daemon start
/etc/init.d/vbus start

# initial mdev device enumeration
mdev -s
# tim done "Rest of networking"

#/etc/init.d/telnetd start
#/etc/init.d/vsftpd start

show-scr

# Normal Play boot
ulimit -c unlimited
echo "|/bin/sh /usr/bin/sysdump.sh /LF/Base/FR %e %p" > /proc/sys/kernel/core_pattern	

# start logging service before everything else
/etc/init.d/flight-recorder start

# Log Keep-alives
/usr/bin/show-scr | head -1 | logger -s -t "Recovery Keep-Alives" -p local4.notice

# set date to avoid errors in mq_timesend() and mq_timereceive() POSIX funcs
if [[ `date +%Y` -lt "2008" -o "2030" -lt `date +%Y` ]]
	then
	date 010101012008
	hwclock --systohc
fi

logger -s -t "Emearld App" -p local4.notice "Unit started in Trapdoor Mode (A+B)"

( sleep 15; # tim begin "Version Logging at 15s"
	BOOT_DEV=/dev/`grep NOR_Boot /proc/mtd | cut -d : -f 1`
	logger -s -t "Emerald Base" -p local4.notice "hostname:         '`hostname`'"
	logger -s -t "Emerald Base" -p local4.notice "Board ID:         '`cat /sys/devices/platform/lf1000-gpio/board_id`'"
	logger -s -t "Emerald Base" -p local4.notice "NOR BootVersion:  '`nice -10 get-bootstrap-version < $BOOT_DEV`'"  # 0.3s
	logger -s -t "Emerald Base" -p local4.notice "NOR SerialNumber: '`mfgdata get sn`'"
	logger -s -t "Emerald Base" -p local4.notice "NAND BootVersion: '`nice -10 get-bootstrap-version < /dev/mtd0`'" # 0.6s
	/etc/init.d/logversion; ### tim done "logversion"
	# tim end "Version Logging"
) &

if [ -e /LF/Base/EmeraldMfgTest/LaunchMfgTest.sh ] ; then 
	logger -s -t "Emearld App" -p local4.notice "Launched Mfg Test from trapdoor mode"
	echo "Trap door mode....starting Mfg Test!!"
	chmod -R +x /LF/Base/EmeraldMfgTest
	/LF/Base/EmeraldMfgTest/LaunchMfgTest.sh &
	/etc/init.d/telnetd start
	/etc/init.d/vsftpd start
	exit 0
elif [ -e /LF/Base/MadridMfgTest/LaunchMfgTest.sh ] ; then 
	logger -s -t "Madrid App" -p local4.notice "Launched Mfg Test from trapdoor mode"
	echo "Trap door mode....starting Mfg Test!!"
	chmod -R +x /LF/Base/MadridMfgTest
	/LF/Base/MadridMfgTest/LaunchMfgTest.sh &
	/etc/init.d/telnetd start
	/etc/init.d/vsftpd start
	exit 0
fi
	

if [ ! "`cat /sys/devices/platform/lf1000-nand/cart_hotswap | cut -f1`" -eq "1" ] ; then
	echo 1 > /sys/devices/platform/lf1000-nand/cart_hotswap
fi

TIME_START=`date +%s`
while [ ! "`cat /sys/devices/platform/lf1000-nand/cart_hotswap | cut -f1`" -eq "1" ] ; do
	TIME_STAMP=`date +%s` 

	if [ "`expr $TIME_STAMP - $TIME_START`" -ge "2" ] ; then 
		echo "Failed to set cartridge hotswap to 1.  Unabel to mount cartridge. Starting normally"
		/usr/bin/app &
		if [ "$MLC" -eq "1" ] ; then
			# Set background color from white to black
			mlc-control /dev/mlc set background 000000
			mlc-control /dev/mlc set dirty
		fi
		exit 1
	fi
done

TIME_START=`date +%s`
while [ ! "`cat /proc/mtd | grep -c Cartridge`" -eq "1" ] ; do
			TIME_STAMP=`date +%s` 
	
			if [ "`expr $TIME_STAMP - $TIME_START`" -ge "5" ] ; then 
				echo "No cartridge inserted.  Skipping cartridge mount"
				/usr/bin/app &
				if [ "$MLC" -eq "1" ] ; then 
					# Set background color from white to black
					mlc-control /dev/mlc set background 000000
					mlc-control /dev/mlc set dirty
				fi
				exit 0
			fi
done 


gpio-control /dev/gpio outenable 2 1  0
gpio-control /dev/gpio outenable 2 8  0
gpio-control /dev/gpio outenable 2 9  0
gpio-control /dev/gpio outenable 2 11 0
                                                                                


#get board id
BOARD_ID="`cat /sys/devices/platform/lf1000-gpio/board_id`"

echo "Board ID: " $BOARD_ID

if [ $BOARD_ID \< "B" ] ; then   # Emerald HW 
	CART_ID=$((`gpio-control /dev/gpio invalue 1 5` * 8))
	CART_ID=$(($CART_ID + (`gpio-control /dev/gpio invalue 1 4` * 4)))
	CART_ID=$(($CART_ID + (`gpio-control /dev/gpio invalue 1 3` * 2)))
	CART_ID=$(($CART_ID + (`gpio-control /dev/gpio invalue 1 2`)))
else
	CART_ID=$((`gpio-control /dev/gpio invalue 2 9` * 8))
	CART_ID=$(($CART_ID + (`gpio-control /dev/gpio invalue 2 11` * 4)))
	CART_ID=$(($CART_ID + (`gpio-control /dev/gpio invalue 2 1` * 2)))
	CART_ID=$(($CART_ID + (`gpio-control /dev/gpio invalue 2 8`)))
fi
                                                                                
echo "Cart ID: $CART_ID" 

if [ "$CART_ID" = "11" -o "$CART_ID" = "6" -o "$CART_ID" = "15" ] ; then 
#if [ ! "`dmesg | tail -n 14 | grep 'NAND device' | grep -c 64MiB`" -eq "1" ] ; then 
	#This means it is a NAND cartridge, so set the ECC mode accordingly
	if [ "`cat /sys/devices/platform/lf1000-nand/cart_ecc_mode`" -eq "0" ] ; then
		echo 1 > /sys/devices/platform/lf1000-nand/cart_ecc_mode
		TIME_START=`date +%s`
		while [ ! "`cat /sys/devices/platform/lf1000-nand/cart_ecc_mode`" -eq "1" ] ; do
			TIME_STAMP=`date +%s` 
	
			if [ "`expr $TIME_STAMP - $TIME_START`" -ge "2" ] ; then 
				echo "Failed to set cartridge ecc mode to 1.  Unabel to mount cartridge.  Starting normally"
				/usr/bin/app &
				if [ "$MLC" -eq "1" ] ; then 
					# Set background color from white to black
					mlc-control /dev/mlc set background 000000
					mlc-control /dev/mlc set dirty
				fi
				exit 1
			fi
		done
	fi
else 
	echo "Skipping enable ECC due to not a NAND cartridge or it is already pre-set"
fi


/etc/init.d/cartridge start -w

TIME_START=`date +%s`
while [ "`mount | grep -c Cart`" -ne "1" ] ; do
	TIME_STAMP=`date +%s` 
	
	if [ "`expr $TIME_STAMP - $TIME_START`" -ge "10" ] ; then 
		echo "Failed to mount cart"
		/usr/bin/app &
		if [ "$MLC" -eq "1" ] ; then 
			# Set background color from white to black
			mlc-control /dev/mlc set background 000000
			mlc-control /dev/mlc set dirty
		fi	
		exit 0
	fi
done

if [ -e /LF/Cart/EmeraldMfgTest/EmeraldMfgTest ] ; then
	echo "Running Emerald Mfg Test from cartridge........."
	logger -s -t "Emearld App" -p local4.notice "Launched Mfg Test cartridge using trapdoor mode"
	/LF/Cart/EmeraldMfgTest/LaunchMfgTest.sh &
	/etc/init.d/telnetd start
	/etc/init.d/vsftpd start
	exit 0
elif [ -e /LF/Cart/MadridMfgTest/MadridMfgTest ] ; then
	echo "Running Madrid Mfg Test from cartridge........."
	logger -s -t "Madrid App" -p local4.notice "Launched Mfg Test cartridge using trapdoor mode"
	/LF/Cart/MadridMfgTest/LaunchMfgTest.sh &
	/etc/init.d/telnetd start
	/etc/init.d/vsftpd start
	exit 0
else
	echo "Cartridge is not a Mfg Test cartridge, running in normal mode"
	/usr/bin/app &
	if [ "$MLC" -eq "1" ] ; then 
		# Set background color from white to black
		mlc-control /dev/mlc set background 000000
		mlc-control /dev/mlc set dirty
	fi
	exit 0
fi 





