#!/bin/sh

# This script mounts misc volumes late (after AppManager starts)
set -x
CART="/LF/Cart"
sys_ret=0
ubi_ret=0

case "$1" in
        start)
                mn=`cat /proc/mtd | grep -e "\bCartridge" | cut -d: -f1 | cut -c4-`
                if [ ! -z "$mn" ]; then
                        where=$CART
                        logger -s -t "Emerald Base" -p local4.notice `tim Start "$where"`
			ubi_present=`cat /sys/devices/platform/lf1000-nand/cart_hotswap | cut -f2`
			if [ $ubi_present = 1 ]; then
				ud=2
				ubiattach /dev/ubi_ctrl -d $ud -m $mn
				ubi_ret=$?
				if [ $ubi_ret = 0 ]; then
					# Broke in 2.6.31: mn=`cat /sys/class/ubi/ubi${ud}_0/vol_mtd_num`
					mn=`cat /proc/mtd | grep -e "\bubi_Cartridge" | cut -d: -f1 | cut -c4-`
				fi
			fi

			if [ $ubi_ret = 0 ]; then
				mount -t vfat -o ro /dev/mtdblock$mn $where
				if [ $? = 0 ]; then
					echo "Success"
				else
					echo "************************************"
					echo "Retrying the mount once"
					echo "************************************"
					mount -t vfat -o ro /dev/mtdblock$mn $where
					if [ $? = 0 ]; then
						echo "Success"
					else
						sys_ret=21
						logger -s -t "Emerald Base" -p local4.err "Failed mount of mtd$un to $where"
					fi
				fi
			else
				sys_ret=11
				logger -s -t "Emerald Base" -p local4.err "Failed ubiattach for mtd$mn!"
			fi
                        logger -s -t "Emerald Base" -p local4.notice `tim Done "$where"`
		else
			sys_ret=31
                        logger -s -t "Emerald Base" -p local4.notice "Can't mount, since no cartridge partition present !"
                fi
                ;;
        stop)
                logger -s -t "Emerald Base" -p local4.notice "Stopping Cartridge !"
		hascart=`mount | grep $CART`
		loop=0
                while [ -n "$hascart" -a $loop -lt 3 ]; do
                        logger -s -t "Emerald Base" -p local4.notice "umount $CART !"
                        umount $CART  > /dev/null
                        hascart=`mount | grep $CART`
			[ -n "$hascart" ] && sleep 1s && echo umount retry $loop ...
			loop=$((++loop))
                done;

		if [ -n "$hascart" ]; then
			sys_ret=21
		else
			ud=2
			if [ -e /sys/class/ubi/ubi$ud ]; then
				ubidetach /dev/ubi_ctrl -d $ud
				if [ $? != 0 ]; then
					sys_ret=11
				fi
			else
				ubi_present=`cat /sys/devices/platform/lf1000-nand/cart_hotswap | cut -f2`
				if [ $ubi_present = 1 ]; then
					sys_ret=12
				fi
			fi
		fi
		;;

	fstop)
		logger -s -t "Emerald Base" -p local4.notice "Force Cartridge umount !!"
		hascart=`mount | grep $CART`
		if [ -n "$hascart" ]; then
			umount -l $CART  > /dev/null
			if [ $? != 0 ]; then
				logger -s -t "Emerald Base" -p local4.notice "Lazy umount failed !!"
				sys_ret = 22
			fi
		fi

                ud=2
		if [ -e /sys/class/ubi/ubi$ud ]; then
			ubidetach /dev/ubi_ctrl -d $ud
			if [ $? != 0 ]; then
				sys_ret=11
			fi
		else
			ubi_present=`cat /sys/devices/platform/lf1000-nand/cart_hotswap | cut -f2`
			if [ $ubi_present = 1 ]; then
				sys_ret=12
			fi
		fi
		;;

	restart)
		logger -s -t "Emerald Base" -p local4.notice "Restarting Cartridge !"
		$0 stop
		$0 start
		;;
	*)
		echo "Usage: $0 {start|stop|restart}"
		exit 1
		;;
esac

exit $sys_ret
