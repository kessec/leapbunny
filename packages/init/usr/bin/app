#!/bin/sh

# launch CartManager
(
sleep 10s
tim begin "CartManager"
# Enable the Cartridge bus
modprobe lfcart; # tim done "modprobe lfcart"
if [ ! -e /flags/console_out ] ; then
        CartManager &> /dev/null
else
        CartManager
fi
) &

# Relaunch AppManager on any non-zero exit code
count=0
result=42;
while [ ! $result = 0 ]; do
	logger -s -t "Emerald Base" -p local4.notice `tim begin "AppManager"`
	if [ ! -e /flags/console_out ] ; then
		su game -c AppManager &> /dev/null
	else
		su game -c AppManager
	fi
	result=$?;
	tim done "AppManager exit($result)"
	uptime=`cut -d '.' -f 1 /proc/uptime`
	count=$((++count))
	logger -s -t "/usr/bin/app" -p local4.notice "AppManager exit($result) count=$count uptime=$uptime"

	# TTPro 2139/2159: Unhandled exceptions that leave OGL locked
	# up need to reboot the system since OGL is left dead
	# otherwise and the user would have to reboot it himself.
	#
	# NOTE: If there is a problem with getting into an infinite reboot
	# loop, look no further!  Here's your man.
	if [ -e /tmp/3dlockup ]; then
		logger -s -t "/usr/bin/app" -p local4.notice "3dlockup detected.  Rebooting!"
		reboot;
	fi

	# Yet another Rube Goldberg linkage: if AppManager left behind a file /tmp/bam-wrapper, then run it once
	BAMW=/tmp/bam-wrapper
	if [ -x $BAMW ]; then
		logger -s -t "/usr/bin/app" -p local4.notice "Request to run $BAMW"
		$BAMW
		result=$?
		logger -s -t "/usr/bin/app" -p local4.notice "$BAMW: exit($result)"
		# Remove so we don't launch it again
		rm $BAMW
	fi

	# Don't relauch if shutdown is pending
	if [ "`cat /sys/devices/platform/lf1000-power/shutdown`" -eq "1" ]; then
		logger -s -t "Emerald Base" -p local4.notice "Shutdown requested, exit AppManager launch loop"
		break;
	fi
done;

# /flags/poweron handled inside AppManager now
poweroff
